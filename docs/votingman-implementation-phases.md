# 보팅맨 서비스 구현 단계 (Implementation Phases)

기획서(`voting-coin-platform-plan.md`)를 기준으로, **보팅맨** 기능을 2차 MVP 전체가 아닌 **이 서비스만 단계적으로** 구현하기 위한 단계 구분입니다.  
한 단계가 안정된 뒤 다음 단계로 진행하는 것을 권장합니다.

---

## 단계 요약 (한눈에)

| 단계 | 이름 | 목표 | 산출물 |
|------|------|------|--------|
| **1** | 로그인 전제 + 보팅코인 기반 | 투표는 로그인만 허용, 사용자별 보팅코인 잔액 도입 | 로그인 전용 투표, users 보팅코인 |
| **2** | 포인트 배팅으로 전환 | 1인 1표 → “보팅코인 N개 걸기” 배팅 | 베팅량 저장·집계, 롱/숏 포인트 비율 |
| **3** | 파리뮤추얼 페이아웃 | 당첨자에게 패자 포인트 분배 | 종가 확정 후 자동 정산·지급 |
| **4** | 3개 시장 섹션 확장 | 비트코인 + 미국주식 + 한국주식 투표 | 폴/투표를 시장·종목별로 분리 |
| **5** | 시장세 + 과거 데이터 시각화 | 5단계 시장세 저장, “과거 같은 시장세 때 결과” 노출 | 시장세 정의·집계, 인간지표 UI 연동 |
| **6** | 가중치 + 티어 시스템 | 고수 가중치 반영, 적중률 티어(배치 5회→브론즈~) | Voting_Power, 티어 계산·노출 |
| **7** | 리더보드 + 홈 고수 포지션 | TOP 5 리더보드, 실시간 고수 포지션 시각화 | 리더보드 API·UI, 홈 위젯 |

---

## 1단계: 로그인 전제 + 보팅코인 기반

**목표**: “로그인한 사람만 투표”로 바꾸고, 사용자별 **보팅코인 잔액**을 쌓을 수 있는 기반을 만든다.

**구현 내용**

- **투표 참여 제한**
  - 인간 지표(데일리 투표)에서 **비로그인 투표 제거**.
  - API: `POST /api/sentiment/vote`에서 로그인 필수. `anonymous_id` 경로 제거 또는 무시.
  - UI: 비로그인 시 “로그인하고 투표하세요” + 로그인 버튼만 노출 (투표 버튼 비활성 또는 미노출).
- **보팅코인 잔액**
  - `users` 테이블에 `voting_coin_balance` (또는 전용 `user_point_balances` 테이블) 추가.
  - 가입/최초 로그인 시 **초기 보팅코인 지급** (예: 1000 코인). 규칙은 기획서/운영 정책에 따라 결정.
- **RLS·인덱스**
  - 본인 잔액만 조회/갱신 가능하도록 RLS 정책 추가.

**완료 기준**

- 로그인 사용자만 데일리(비트코인) 투표 가능.
- 사용자별 보팅코인 잔액이 DB에 있고, 초기 지급 후 조회 가능.

**선택(이 단계 이후)**

- 카카오 로그인: 이 단계에서 필수는 아니고, 로그인 전제만 만족하면 이후 단계에서 추가 가능.

---

## 2단계: 포인트 배팅으로 전환

**목표**: “1인 1표”가 아니라 **“보팅코인 N개를 걸어서”** 롱/숏 중 하나에 배팅하는 구조로 바꾼다.

**구현 내용**

- **DB**
  - `sentiment_votes`에 **`bet_amount`** (integer, 배팅한 보팅코인 수) 추가.
  - `sentiment_polls`에 **`long_points`**, **`short_points`** 추가 (롱/숏 쪽에 걸린 포인트 합계).  
    기존 `long_count`/`short_count`는 제거하거나 “참여 인원 수” 용도로만 유지할지 결정.
- **로직**
  - 투표(배팅) 시: 사용자 잔액에서 `bet_amount` 차감, `sentiment_votes`에 `choice` + `bet_amount` 저장.
  - 같은 날 **수정** 시: 기존 베팅 포인트 반환 후 새 베팅만큼 다시 차감.
  - **1인 1폴 1투표** 유지: 한 날짜에 한 사용자당 하나의 행만 (choice + bet_amount 업데이트).
- **집계**
  - 폴별로 `long_points` / `short_points`를 `sentiment_votes` 합으로 갱신 (투표/수정/취소 시 트리거 또는 API에서 갱신).
- **UI**
  - “롱/숏 선택”에 더해 **“몇 코인 걸까?”** 입력(또는 버튼) 추가.
  - 현재 롱/숏 **비율을 포인트 기준**으로 표시 (예: “롱 65% / 숏 35%”).

**완료 기준**

- 데일리 비트코인 투표가 “보팅코인 N개 걸기”로 동작.
- 롱/숏 비율이 포인트 합계 기준으로 노출됨.

---

## 3단계: 파리뮤추얼 페이아웃

**목표**: 해당 일봉 **종가 확정 후**, 당첨자에게 패자들이 걸었던 보팅코인을 파리뮤추얼 방식으로 분배한다.

**구현 내용**

- **종가 확정**
  - 기존처럼 **다음날 KST 00:00(또는 00:01) 이후** 해당일 `btc_close` 수집·저장하는 cron/job 유지.
- **정산 로직**
  - 해당 `poll_date`의 결과(시가·종가)로 롱/숏 당첨 여부 판정.
  - **당첨자**: 롱 당첨자들끼리 “롱 풀”을, 숏 당첨자들끼리 “숏 풀”을 나눠 가짐.  
    (파리뮤추얼: 같은 선택 내에서 베팅 비율대로 분배.)
  - **수수료**: 운영 정책에 따라 풀에서 일부 공제 후 분배할지 결정.
- **잔액 반영**
  - 당첨자 `user_id`별로 받을 보팅코인 계산 후 `users.voting_coin_balance`(또는 포인트 테이블) 갱신.
  - **정산 이력** 저장용 테이블(예: `payout_history`) 있으면 이후 가중치·통계에 활용 가능.
- **재실행 방지**
  - 해당 폴에 대해 “이미 정산 완료” 플래그를 두고, 한 번만 실행되도록 처리.

**완료 기준**

- 매일 종가 확정 후 자동으로 정산이 돌고, 당첨자 잔액이 증가함.
- (선택) 사용자에게 “어제 투표 결과: 당첨 / 낙첨, +N 보팅코인” 등 간단 노출.

---

## 4단계: 3개 시장 섹션 확장

**목표**: 인간 지표를 **비트코인 / 미국 주식 / 한국 주식** 3개 섹션으로 나누고, 각 섹션별로 투표(배팅)할 수 있게 한다.

**구현 내용**

- **폴·시장 구분**
  - `sentiment_polls`에 **시장/종목 구분** 컬럼 추가 (예: `market` 또는 `symbol`: `btc`, `ndq`, `sp500`, `kospi`, `kosdaq`).
  - 또는 폴을 “날짜 + 시장” 단위로 확장해, **하루에 비트코인 1개 + 미국주식 2개(나스닥, S&P500) + 한국주식 2개(코스피, 코스닥)** 형태로 5개 폴이 생기도록 설계.
- **가격 데이터**
  - 비트코인: 기존 Binance 등 (시가/종가 KST 기준).
  - 미국 주식(나스닥, S&P500): 해당 지수/ETF의 일봉 시가·종가 수집 (데이터 소스·시간대 정의 필요).
  - 한국 주식(코스피, 코스닥): KRX 또는 유료 데이터 소스로 시가·종가 수집.
- **투표·API**
  - “오늘 비트코인”, “오늘 나스닥”, … 별로 폴 ID가 다르므로, **폴별로** 투표 요청 (`POST /api/sentiment/vote`에 `poll_id` 또는 `market`+`symbol`).
  - 사용자는 **보팅코인을 시장별로 나눠서** 걸 수 있도록 (예: 비트코인 100, 나스닥 50).
- **UI**
  - 인간 지표 영역을 **3개 블록**으로 구분: 비트코인 | 미국 주식(나스닥, S&P500) | 한국 주식(코스피, 코스닥).
  - 각 블록에서 해당 종목의 “오늘 방향”에 보팅코인 배팅.

**완료 기준**

- 3개 섹션에서 각각 (비트코인 1 + 미국 2 + 한국 2) 종목에 대해 데일리 투표·집계가 동작함.
- 종가 확정·정산도 시장별로 동일한 파리뮤추얼 로직 적용 가능한 구조.

---

## 5단계: 시장세 + 과거 데이터 시각화

**목표**: 시장세를 **폭등장·상승장·횡보장·하락장·폭락장** 5단계로 정의하고, “과거 같은 시장세일 때 사람들이 어떻게 배팅했고, 결과·승률이 어땠는지”를 시각화한다.

**구현 내용**

- **시장세 정의**
  - 일봉(또는 기간) 수익률(또는 변동폭) 기준으로 5단계 구간 규칙 정의 (예: % 변동폭 구간).
  - 폴별(또는 일별)로 **`market_regime`** (또는 유사 컬럼) 저장.
- **저장·집계**
  - 연·월·주·일 단위로 시장세·배팅 비율·당첨 비율(승률)을 집계해 저장하거나 뷰/마트 테이블로 만듦.
- **시각화(인간 지표 UI)**
  - “현재 시장세: 상승장”처럼 **현재 시장세** 표시.
  - “과거 상승장일 때: 롱 xx% / 숏 yy%, 당첨률 zz%” 같은 **과거 동일 시장세 통계** 노출.
  - “지금 올랐어? 내렸어?”에 맞춰 **직관적인 문구·차트** (예: 전일 대비 ↑/↓, %).

**완료 기준**

- 시장세가 자동 또는 반자동으로 저장·분류됨.
- 인간 지표 섹션에서 “현재 시장세 + 과거 같은 시장세 때 배팅·승률”을 볼 수 있음.

---

## 6단계: 가중치 + 티어 시스템

**목표**: “많이 맞춘 사람”의 의견이 더 반영되도록 **가중치(Voting_Power)**를 도입하고, **적중률 티어**(배치 5회 → 브론즈~)를 도입해 우월감·동기 부여를 준다.

**구현 내용**

- **가중치**
  - `Voting_Power = log(Total_Point) × Accuracy_Rate²` 계산 (보유 포인트 + 과거 적중률).
  - 집계 시 “단순 포인트 합”이 아니라 **가중치 합**으로 “가중치 합산 포지션” 계산.
  - **상위 1% 포지션**: 리더보드/통계 테이블에서 상위 1% 사용자들의 롱/숏 비율을 따로 집계해 노출.
- **티어**
  - **배치**: 최초 5번의 투표 결과(당첨/낙첨)로 “배치 등급” 계산.
  - **티어**: 브론즈 → 실버 → 골드 → … (기획서에 맞게 구간 정의).
  - 사용자 테이블(또는 전용 프로필)에 `tier`, `placement_done` 등 저장.
  - 로그인 시 **내 티어** 노출 (프로필, 인간 지표 근처 등).
- **API**
  - 가중치 합산 포지션 조회, 상위 1% 포지션 조회, 티어 조회 API.

**완료 기준**

- 롱/숏 비율에 “가중치 합산” 지표가 반영되고, 상위 1% 포지션을 별도로 볼 수 있음.
- 사용자별 티어가 계산·저장되고, 로그인 시 노출됨.

---

## 7단계: 리더보드 + 홈 고수 포지션

**목표**: **보팅코인(또는 승률) 기준 TOP 5 리더보드**를 만들고, 이 고수들의 **실시간 포지션**을 홈에서 시각화한다.

**구현 내용**

- **리더보드**
  - 보팅코인 잔액 또는 “최근 N회 승률” 기준 상위 5명 조회 API.
  - 리더보드 전용 페이지 또는 홈 내 블록: 순위, 닉네임, 보팅코인(또는 승률), 티어.
- **실시간 포지션**
  - TOP 5 사용자의 “오늘 투표(롱/숏)”를 해당 폴별로 조회해 “고수들은 지금 롱/숏” 형태로 표시.
  - 비트코인 / 미국주식 / 한국주식 섹션별로 “고수 N명 중 롱 m명, 숏 n명” 등 요약 가능.
- **홈 배치**
  - 기존 홈 화면에 “실시간 고수 포지션” 위젯 추가 (리더보드 + 오늘 포지션 요약).

**완료 기준**

- TOP 5 리더보드가 노출되고, 해당 고수들의 당일 포지션이 인간 지표·홈에서 확인 가능함.

---

## 단계별 의존 관계

```
1 (로그인 전제 + 보팅코인)
  → 2 (포인트 배팅)
  → 3 (페이아웃)
  → 4 (3개 시장)  ← 여기까지가 “데일리 배팅이 3개 시장에서 돈다” 상태
  → 5 (시장세 + 시각화)
  → 6 (가중치 + 티어)
  → 7 (리더보드 + 홈)
```

- **1→2→3**은 순서 고정 권장 (포인트 없이 배팅·페이아웃 불가).
- **4**는 3까지 완료 후 진행하면, 한 시장(비트코인)에서 이미 정산이 검증된 상태에서 다른 시장을 붙이기 좋음.
- **5**는 4에서 시장·종목이 늘어난 뒤 시장세를 붙이기 적합.
- **6·7**은 데이터가 쌓인 뒤 티어·리더보드가 의미 있으므로 3·4가 안정된 후 진행.

---

## 문서 이력

- 최초 작성: 보팅맨 서비스 단계별 구현 계획 정리 (기획서 및 인간 지표 DB 설계 반영).
