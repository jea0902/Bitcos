# btc_close(종가) 정의 — "지금 시세"가 아닌 이유

## 질문: btc_close는 무슨 값인가? 일봉이 아직 마감 안 됐는데 어떻게 저장하나?

### 답변 요약

- **btc_close는 "지금 시세"가 아닙니다.**  
  **그날 일봉이 공식적으로 마감되는 시각(KST 다음날 00:00)** 의 가격 한 시점만 저장합니다.
- **오늘(2월 6일) 일봉**은 아직 마감되지 않았으므로, **오늘 폴의 btc_close는 의도적으로 null**입니다.  
  내일 00:01 KST 크론이 돌 때 그때 비로소 “2월 6일 종가”가 저장됩니다.

---

## 1. 종가(btc_close)의 정의

| 항목 | 내용 |
|------|------|
| **정의** | `poll_date`인 그날의 **일봉 종가** = **다음날 KST 00:00** 시점의 가격 1개. |
| **예** | 2월 5일 일봉 종가 = **2월 6일 00:00 KST** 시점의 BTC 가격. |
| **출처** | Binance 1h 봉 중 “2월 6일 00:00 KST에 **시작하는** 봉”의 **시가(open)** = 그 시각의 가격. |

즉, **“그날 거래가 끝난 뒤 정해지는 공식 종가”**를 쓰는 것이지, **“지금 이 순간 시세”**를 쓰는 것이 아닙니다.

---

## 2. 그래서 응답에 나온 숫자는 무엇인가?

- **2026-02-05**  
  - `btc_close: 69404.75`  
  - 의미: **2월 6일 00:00 KST** 시점의 가격.  
  - 2월 5일 일봉은 “2월 6일 00:00 KST”에 이미 마감된 상태이므로, 그 시각의 가격을 저장한 것이 맞습니다.  
  - **지금 시세가 65,000대라도**, 우리가 저장하는 건 “2월 6일 00:00 KST 그 순간”의 가격이므로 69,404.75가 맞을 수 있습니다. (시간이 지나면서 가격이 내려온 것.)

- **2026-02-06**  
  - `btc_open: 69404.75`, `btc_close: null`  
  - 2월 6일 일봉은 **아직 마감 전**이므로:  
    - 시가(2월 6일 00:00 KST)만 저장하고,  
    - **종가는 저장하지 않음 → null이 정상**입니다.  
  - 2월 6일 일봉의 종가는 **2월 7일 00:00 KST** 시점 가격이므로, **내일 00:01 KST 크론**이 돌 때 비로소 DB에 들어갑니다.

---

## 3. “일봉 마감 전인데 어떻게 종가를 매기고 저장하냐”에 대해

- **오늘 일봉**에는 종가를 **매기지도, 저장하지도 않습니다.**  
  → 오늘 폴의 `btc_close`는 **항상 null**로 두고, 내일 00:01에만 채웁니다.
- **어제 일봉**은 “오늘 00:00 KST”에 이미 마감되었기 때문에,  
  → 그 시각의 가격 1개를 **그날의 종가**로 정해 저장하는 것이고,  
  → 그 시각이 지났으므로 Binance에서 그 시점 봉을 가져와 저장하는 것은 문제 없습니다.

정리하면:

- **마감된 일봉** → 그 일봉의 **정의된 종가 시각(다음날 00:00 KST)** 1개만 저장.
- **아직 마감 안 된 오늘 일봉** → 종가는 저장하지 않음 (null).  
  → 그래서 “일봉 마감 전에 종가를 매기고 저장한다”는 일이 발생하지 않습니다.

---

## 4. 코드/데이터 흐름 요약

- `src/lib/binance/btc-kst.ts`:  
  - `poll_date` 일봉의 **종가** = “(poll_date + 1일) 00:00 KST”에 **시작하는** 1h 봉의 open.  
  - 그 시각이 **아직 안 왔으면** Binance에 해당 봉이 없을 수 있어 `btc_close`는 null.
- 크론(`btc-ohlc-daily`):  
  - **어제** 폴 → 어제 일봉은 이미 “오늘 00:00 KST”에 마감됐으므로 시가·종가 둘 다 채움.  
  - **오늘** 폴 → 오늘 일봉은 아직 마감 전이므로 시가만 채우고, 종가는 null 유지.

이렇게 해서 “마감되지 않은 일봉에 종가를 넣는” 경우는 없고, **마감 시각 1시점의 가격만** btc_close로 사용합니다.
